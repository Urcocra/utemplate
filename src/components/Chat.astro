---
// Chat.astro 组件脚本部分
---

<div id="chat-container" class="max-w-4xl mx-auto bg-white rounded-lg shadow-lg">
  <!-- 聊天标题 -->
  <div class="bg-blue-600 text-white p-4 rounded-t-lg">
    <h2 class="text-xl font-bold">Ollama AI 聊天</h2>
    <div class="flex items-center mt-2">
      <span class="text-sm">模型:</span>
      <select id="model-select" class="ml-2 bg-blue-500 text-white border-none rounded px-2 py-1 text-sm">
        <option value="">加载中...</option>
      </select>
      <div id="status-indicator" class="ml-4 flex items-center">
        <div class="w-2 h-2 bg-red-500 rounded-full mr-2"></div>
        <span class="text-sm">连接中...</span>
      </div>
    </div>
  </div>

  <!-- 聊天消息区域 -->
  <div id="messages-container" class="h-96 overflow-y-auto p-4 space-y-4">
    <div class="text-center text-gray-500">
      <p>欢迎使用 Ollama AI 聊天！请输入您的消息开始对话。</p>
    </div>
  </div>

  <!-- 输入区域 -->
  <div class="border-t p-4">
    <div class="flex space-x-2">
      <input
        id="message-input"
        type="text"
        placeholder="输入您的消息..."
        class="flex-1 border border-gray-300 rounded-lg px-4 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500"
        disabled
      />
      <button
        id="send-button"
        class="bg-blue-600 text-white px-6 py-2 rounded-lg hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 disabled:bg-gray-400"
        disabled
      >
        发送
      </button>
    </div>
  </div>
</div>

<script>
  class OllamaChat {
    messagesContainer;
    messageInput;
    sendButton;
    modelSelect;
    statusIndicator;

    constructor() {
      this.messagesContainer = document.getElementById('messages-container');
      this.messageInput = document.getElementById('message-input');
      this.sendButton = document.getElementById('send-button');
      this.modelSelect = document.getElementById('model-select');
      this.statusIndicator = document.getElementById('status-indicator');
      
      this.init();
    }

    async init() {
      await this.loadModels();
      this.setupEventListeners();
      this.checkOllamaStatus();
    }

    async loadModels() {
      try {
        const response = await fetch('/api/models');
        const data = await response.json();
        
        this.modelSelect.innerHTML = '';
        
        if (data.success && data.models.length > 0) {
          data.models.forEach(model => {
            const option = document.createElement('option');
            option.value = model.name;
            option.textContent = model.name;
            this.modelSelect.appendChild(option);
          });
          
          // 选择第一个模型作为默认
          this.modelSelect.selectedIndex = 0;
        } else {
          const option = document.createElement('option');
          option.value = '';
          option.textContent = '无可用模型';
          this.modelSelect.appendChild(option);
        }
      } catch (error) {
        console.error('加载模型失败:', error);
        this.modelSelect.innerHTML = '<option value="">加载失败</option>';
      }
    }

    async checkOllamaStatus() {
      try {
        const response = await fetch('/api/models');
        const data = await response.json();
        
        if (data.success) {
          this.updateStatus(true, '已连接');
          this.messageInput.disabled = false;
          this.sendButton.disabled = false;
        } else {
          this.updateStatus(false, '连接失败');
          this.messageInput.disabled = true;
          this.sendButton.disabled = true;
        }
      } catch (error) {
        this.updateStatus(false, '连接失败');
        this.messageInput.disabled = true;
        this.sendButton.disabled = true;
      }
    }

    updateStatus(connected, text) {
      const indicator = this.statusIndicator.querySelector('div');
      const statusText = this.statusIndicator.querySelector('span');
      
      indicator.className = `w-2 h-2 rounded-full mr-2 ${connected ? 'bg-green-500' : 'bg-red-500'}`;
      statusText.textContent = text;
    }

    setupEventListeners() {
      this.sendButton.addEventListener('click', () => this.sendMessage());
      
      this.messageInput.addEventListener('keypress', (e) => {
        if (e.key === 'Enter' && !e.shiftKey) {
          e.preventDefault();
          this.sendMessage();
        }
      });
    }

    async sendMessage() {
      const message = this.messageInput.value.trim();
      const selectedModel = this.modelSelect.value;
      
      if (!message || !selectedModel) return;

      // 显示用户消息
      this.addMessage(message, 'user');
      this.messageInput.value = '';
      
      // 显示加载状态
      const loadingElement = this.addMessage('AI 正在思考...', 'ai', true);
      
      try {
        const response = await fetch('/api/chat', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            message: message,
            model: selectedModel
          })
        });

        const data = await response.json();
        
        // 移除加载状态
        loadingElement.remove();
        
        if (data.success) {
          this.addMessage(data.data, 'ai');
        } else {
          this.addMessage(`错误: ${data.error}`, 'error');
        }
      } catch (error) {
        loadingElement.remove();
        this.addMessage(`网络错误: ${error.message}`, 'error');
      }
    }

    addMessage(content, type, isLoading = false) {
      const messageDiv = document.createElement('div');
      messageDiv.className = `flex ${type === 'user' ? 'justify-end' : 'justify-start'}`;
      
      let bgColor, textColor;
      switch (type) {
        case 'user':
          bgColor = 'bg-blue-600';
          textColor = 'text-white';
          break;
        case 'ai':
          bgColor = 'bg-gray-200';
          textColor = 'text-gray-800';
          break;
        case 'error':
          bgColor = 'bg-red-100';
          textColor = 'text-red-800';
          break;
        default:
          bgColor = 'bg-gray-100';
          textColor = 'text-gray-800';
      }

      messageDiv.innerHTML = `
        <div class="${bgColor} ${textColor} rounded-lg p-3 max-w-xs lg:max-w-md ${isLoading ? 'animate-pulse' : ''}">
          <pre class="whitespace-pre-wrap text-sm">${content}</pre>
        </div>
      `;

      this.messagesContainer.appendChild(messageDiv);
      this.messagesContainer.scrollTop = this.messagesContainer.scrollHeight;
      
      return messageDiv;
    }
  }

  // 初始化聊天界面
  document.addEventListener('DOMContentLoaded', () => {
    new OllamaChat();
  });
</script>